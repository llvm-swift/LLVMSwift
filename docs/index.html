<!DOCTYPE html>
<html lang="en">
  <head>
    <title>  Reference</title>
    <link rel="stylesheet" type="text/css" href="css/jazzy.css" />
    <link rel="stylesheet" type="text/css" href="css/highlight.css" />
    <meta charset='utf-8'>
    <script src="js/jquery.min.js" defer></script>
    <script src="js/jazzy.js" defer></script>
    
  </head>
  <body>
    <a title="  Reference"></a>
    <header>
      <div class="content-wrapper">
        <p><a href="index.html"> Docs</a> (99% documented)</p>
      </div>
    </header>
    <div class="content-wrapper">
      <p id="breadcrumbs">
        <a href="index.html"> Reference</a>
        <img id="carat" src="img/carat.png" />
          Reference
      </p>
    </div>
    <div class="content-wrapper">
      <nav class="sidebar">
        <ul class="nav-groups">
          <li class="nav-group-name">
            <a href="Classes.html">Classes</a>
            <ul class="nav-group-tasks">
              <li class="nav-group-task">
                <a href="Classes/Context.html">Context</a>
              </li>
              <li class="nav-group-task">
                <a href="Classes/Function.html">Function</a>
              </li>
              <li class="nav-group-task">
                <a href="Classes/FunctionPassManager.html">FunctionPassManager</a>
              </li>
              <li class="nav-group-task">
                <a href="Classes/IRBuilder.html">IRBuilder</a>
              </li>
              <li class="nav-group-task">
                <a href="Classes/JIT.html">JIT</a>
              </li>
              <li class="nav-group-task">
                <a href="Classes/MemoryBuffer.html">MemoryBuffer</a>
              </li>
              <li class="nav-group-task">
                <a href="Classes/Module.html">Module</a>
              </li>
              <li class="nav-group-task">
                <a href="Classes/ObjectFile.html">ObjectFile</a>
              </li>
              <li class="nav-group-task">
                <a href="Classes/RelocationSequence.html">RelocationSequence</a>
              </li>
              <li class="nav-group-task">
                <a href="Classes/SectionSequence.html">SectionSequence</a>
              </li>
              <li class="nav-group-task">
                <a href="Classes/SymbolSequence.html">SymbolSequence</a>
              </li>
              <li class="nav-group-task">
                <a href="Classes/Target.html">Target</a>
              </li>
              <li class="nav-group-task">
                <a href="Classes/TargetData.html">TargetData</a>
              </li>
              <li class="nav-group-task">
                <a href="Classes/TargetMachine.html">TargetMachine</a>
              </li>
            </ul>
          </li>
          <li class="nav-group-name">
            <a href="Enums.html">Enums</a>
            <ul class="nav-group-tasks">
              <li class="nav-group-task">
                <a href="Enums/AtomicOrdering.html">AtomicOrdering</a>
              </li>
              <li class="nav-group-task">
                <a href="Enums/AtomicReadModifyWriteOperation.html">AtomicReadModifyWriteOperation</a>
              </li>
              <li class="nav-group-task">
                <a href="Enums/ByteOrder.html">ByteOrder</a>
              </li>
              <li class="nav-group-task">
                <a href="Enums/CallingConvention.html">CallingConvention</a>
              </li>
              <li class="nav-group-task">
                <a href="Enums/CodeGenOptLevel.html">CodeGenOptLevel</a>
              </li>
              <li class="nav-group-task">
                <a href="Enums/CodeModel.html">CodeModel</a>
              </li>
              <li class="nav-group-task">
                <a href="Enums/CodegenFileType.html">CodegenFileType</a>
              </li>
              <li class="nav-group-task">
                <a href="Enums/FloatType.html">FloatType</a>
              </li>
              <li class="nav-group-task">
                <a href="Enums.html#/s:O4LLVM8Floating">Floating</a>
              </li>
              <li class="nav-group-task">
                <a href="Enums/FunctionPass.html">FunctionPass</a>
              </li>
              <li class="nav-group-task">
                <a href="Enums/IntPredicate.html">IntPredicate</a>
              </li>
              <li class="nav-group-task">
                <a href="Enums/JITError.html">JITError</a>
              </li>
              <li class="nav-group-task">
                <a href="Enums/LandingPadClause.html">LandingPadClause</a>
              </li>
              <li class="nav-group-task">
                <a href="Enums/Linkage.html">Linkage</a>
              </li>
              <li class="nav-group-task">
                <a href="Enums/MemoryBufferError.html">MemoryBufferError</a>
              </li>
              <li class="nav-group-task">
                <a href="Enums/ModuleError.html">ModuleError</a>
              </li>
              <li class="nav-group-task">
                <a href="Enums/OpCode.html">OpCode</a>
              </li>
              <li class="nav-group-task">
                <a href="Enums/OpCode/Binary.html">– Binary</a>
              </li>
              <li class="nav-group-task">
                <a href="Enums/OpCode/Cast.html">– Cast</a>
              </li>
              <li class="nav-group-task">
                <a href="Enums/OverflowBehavior.html">OverflowBehavior</a>
              </li>
              <li class="nav-group-task">
                <a href="Enums/RealPredicate.html">RealPredicate</a>
              </li>
              <li class="nav-group-task">
                <a href="Enums/RelocMode.html">RelocMode</a>
              </li>
              <li class="nav-group-task">
                <a href="Enums.html#/s:O4LLVM6Signed">Signed</a>
              </li>
              <li class="nav-group-task">
                <a href="Enums/StorageClass.html">StorageClass</a>
              </li>
              <li class="nav-group-task">
                <a href="Enums/TargetMachineError.html">TargetMachineError</a>
              </li>
              <li class="nav-group-task">
                <a href="Enums/ThreadLocalModel.html">ThreadLocalModel</a>
              </li>
              <li class="nav-group-task">
                <a href="Enums.html#/s:O4LLVM8Unsigned">Unsigned</a>
              </li>
              <li class="nav-group-task">
                <a href="Enums/Visibility.html">Visibility</a>
              </li>
            </ul>
          </li>
          <li class="nav-group-name">
            <a href="Extensions.html">Extensions</a>
            <ul class="nav-group-tasks">
              <li class="nav-group-task">
                <a href="Extensions/Bool.html">Bool</a>
              </li>
              <li class="nav-group-task">
                <a href="Extensions/Int.html">Int</a>
              </li>
              <li class="nav-group-task">
                <a href="Extensions/Int16.html">Int16</a>
              </li>
              <li class="nav-group-task">
                <a href="Extensions/Int32.html">Int32</a>
              </li>
              <li class="nav-group-task">
                <a href="Extensions/Int64.html">Int64</a>
              </li>
              <li class="nav-group-task">
                <a href="Extensions/Int8.html">Int8</a>
              </li>
              <li class="nav-group-task">
                <a href="Extensions/LLVMValueRef.html">LLVMValueRef</a>
              </li>
              <li class="nav-group-task">
                <a href="Extensions/String.html">String</a>
              </li>
              <li class="nav-group-task">
                <a href="Extensions/UInt.html">UInt</a>
              </li>
              <li class="nav-group-task">
                <a href="Extensions/UInt16.html">UInt16</a>
              </li>
              <li class="nav-group-task">
                <a href="Extensions/UInt32.html">UInt32</a>
              </li>
              <li class="nav-group-task">
                <a href="Extensions/UInt64.html">UInt64</a>
              </li>
              <li class="nav-group-task">
                <a href="Extensions/UInt8.html">UInt8</a>
              </li>
            </ul>
          </li>
          <li class="nav-group-name">
            <a href="Functions.html">Functions</a>
            <ul class="nav-group-tasks">
              <li class="nav-group-task">
                <a href="Functions.html#/s:F4LLVMop1sFGVS_8ConstantOS_6Signed_GS0_S1__">-(_:)</a>
              </li>
              <li class="nav-group-task">
                <a href="Functions.html#/s:F4LLVMop1sFGVS_8ConstantOS_8Floating_GS0_S1__">-(_:)</a>
              </li>
            </ul>
          </li>
          <li class="nav-group-name">
            <a href="Protocols.html">Protocols</a>
            <ul class="nav-group-tasks">
              <li class="nav-group-task">
                <a href="Protocols.html#/s:P4LLVM22ConstantRepresentation">ConstantRepresentation</a>
              </li>
              <li class="nav-group-task">
                <a href="Protocols/IRGlobal.html">IRGlobal</a>
              </li>
              <li class="nav-group-task">
                <a href="Protocols/IRType.html">IRType</a>
              </li>
              <li class="nav-group-task">
                <a href="Protocols/IRValue.html">IRValue</a>
              </li>
              <li class="nav-group-task">
                <a href="Protocols.html#/s:P4LLVM30IntegralConstantRepresentation">IntegralConstantRepresentation</a>
              </li>
            </ul>
          </li>
          <li class="nav-group-name">
            <a href="Structs.html">Structs</a>
            <ul class="nav-group-tasks">
              <li class="nav-group-task">
                <a href="Structs/Alias.html">Alias</a>
              </li>
              <li class="nav-group-task">
                <a href="Structs/ArrayType.html">ArrayType</a>
              </li>
              <li class="nav-group-task">
                <a href="Structs/BasicBlock.html">BasicBlock</a>
              </li>
              <li class="nav-group-task">
                <a href="Structs/BasicBlock/Address.html">– Address</a>
              </li>
              <li class="nav-group-task">
                <a href="Structs/Call.html">Call</a>
              </li>
              <li class="nav-group-task">
                <a href="Structs/Constant.html">Constant</a>
              </li>
              <li class="nav-group-task">
                <a href="Structs/FunctionType.html">FunctionType</a>
              </li>
              <li class="nav-group-task">
                <a href="Structs/Global.html">Global</a>
              </li>
              <li class="nav-group-task">
                <a href="Structs/Instruction.html">Instruction</a>
              </li>
              <li class="nav-group-task">
                <a href="Structs/IntType.html">IntType</a>
              </li>
              <li class="nav-group-task">
                <a href="Structs/Invoke.html">Invoke</a>
              </li>
              <li class="nav-group-task">
                <a href="Structs/LabelType.html">LabelType</a>
              </li>
              <li class="nav-group-task">
                <a href="Structs/MetadataType.html">MetadataType</a>
              </li>
              <li class="nav-group-task">
                <a href="Structs/Parameter.html">Parameter</a>
              </li>
              <li class="nav-group-task">
                <a href="Structs/PhiNode.html">PhiNode</a>
              </li>
              <li class="nav-group-task">
                <a href="Structs/PointerType.html">PointerType</a>
              </li>
              <li class="nav-group-task">
                <a href="Structs/Relocation.html">Relocation</a>
              </li>
              <li class="nav-group-task">
                <a href="Structs/Section.html">Section</a>
              </li>
              <li class="nav-group-task">
                <a href="Structs/StructType.html">StructType</a>
              </li>
              <li class="nav-group-task">
                <a href="Structs/Switch.html">Switch</a>
              </li>
              <li class="nav-group-task">
                <a href="Structs/Symbol.html">Symbol</a>
              </li>
              <li class="nav-group-task">
                <a href="Structs/TerminatorInstruction.html">TerminatorInstruction</a>
              </li>
              <li class="nav-group-task">
                <a href="Structs/TokenType.html">TokenType</a>
              </li>
              <li class="nav-group-task">
                <a href="Structs/Use.html">Use</a>
              </li>
              <li class="nav-group-task">
                <a href="Structs/VectorType.html">VectorType</a>
              </li>
              <li class="nav-group-task">
                <a href="Structs/VoidType.html">VoidType</a>
              </li>
              <li class="nav-group-task">
                <a href="Structs/X86MMXType.html">X86MMXType</a>
              </li>
            </ul>
          </li>
        </ul>
      </nav>
      <article class="main-content">
        <section>
          <section class="section">
            
            <h1 id='llvmswift' class='heading'>LLVMSwift</h1>

<p><a href="https://travis-ci.org/trill-lang/LLVMSwift"><img src="https://travis-ci.org/trill-lang/LLVMSwift.svg?branch=master" alt="Build Status"></a> <a href="https://trill-lang.github.io/LLVMSwift"><img src="https://cdn.rawgit.com/trill-lang/LLVMSwift/master/docs/badge.svg" alt="Documentation"></a> <a href="https://llvmswift-slack.herokuapp.com"><img src="https://llvmswift-slack.herokuapp.com/badge.svg" alt="Slack Invite"></a></p>

<p>LLVMSwift is a pure Swift interface to the <a href="http://llvm.org">LLVM</a> API and its associated libraries. It provides native, easy-to-use components to make compiler development fun.</p>
<h2 id='introduction' class='heading'>Introduction</h2>
<h3 id='llvm-ir' class='heading'>LLVM IR</h3>

<p>The root unit of organization of an LLVM IR program is a <code>Module</code></p>
<pre class="highlight swift"><code><span class="k">let</span> <span class="nv">module</span> <span class="o">=</span> <span class="kt">Module</span><span class="p">(</span><span class="nv">name</span><span class="p">:</span> <span class="s">"main"</span><span class="p">)</span>
</code></pre>

<p>LLVM IR is construction is done with an <code>IRBuilder</code> object.  An <code>IRBuilder</code> is a cursor pointed inside a context, and as such has ways of extending that context and moving around inside of it.</p>

<p>Defining a simple function and moving the cursor to a point where we can begin inserting instructions is done like so:</p>
<pre class="highlight swift"><code><span class="k">let</span> <span class="nv">builder</span> <span class="o">=</span> <span class="kt">IRBuilder</span><span class="p">(</span><span class="nv">module</span><span class="p">:</span> <span class="n">module</span><span class="p">)</span>

<span class="k">let</span> <span class="nv">main</span> <span class="o">=</span> <span class="n">builder</span><span class="o">.</span><span class="nf">addFunction</span><span class="p">(</span>
             <span class="nv">name</span><span class="p">:</span> <span class="s">"main"</span><span class="p">,</span> 
             <span class="nv">type</span><span class="p">:</span> <span class="kt">FunctionType</span><span class="p">(</span><span class="nv">argTypes</span><span class="p">:</span> <span class="p">[],</span>
             <span class="nv">returnType</span><span class="p">:</span> <span class="kt">VoidType</span><span class="p">())</span>
           <span class="p">)</span>
<span class="k">let</span> <span class="nv">entry</span> <span class="o">=</span> <span class="n">main</span><span class="o">.</span><span class="nf">appendBasicBlock</span><span class="p">(</span><span class="nv">named</span><span class="p">:</span> <span class="s">"entry"</span><span class="p">)</span>
<span class="n">builder</span><span class="o">.</span><span class="nf">positionAtEnd</span><span class="p">(</span><span class="nv">of</span><span class="p">:</span> <span class="n">entry</span><span class="p">)</span>
</code></pre>

<p>Inserting instructions creates native <code>IRValue</code> placeholder objects that allow us to structure LLVM IR programs just like Swift programs:</p>
<pre class="highlight swift"><code><span class="k">let</span> <span class="nv">constant</span> <span class="o">=</span> <span class="kt">IntType</span><span class="o">.</span><span class="n">int64</span><span class="o">.</span><span class="nf">constant</span><span class="p">(</span><span class="mi">21</span><span class="p">)</span>
<span class="k">let</span> <span class="nv">sum</span> <span class="o">=</span> <span class="n">builder</span><span class="o">.</span><span class="nf">buildAdd</span><span class="p">(</span><span class="n">constant</span><span class="p">,</span> <span class="n">constant</span><span class="p">)</span>
<span class="n">builder</span><span class="o">.</span><span class="nf">buildRet</span><span class="p">(</span><span class="n">sum</span><span class="p">)</span>
</code></pre>

<p>This simple program generates the following IR:</p>
<pre class="highlight llvm"><code><span class="err">//</span> <span class="k">module</span><span class="p">.</span><span class="err">dump</span><span class="p">()</span>

<span class="k">define</span> <span class="kt">void</span> <span class="vg">@main</span><span class="p">()</span> <span class="p">{</span>
<span class="nl">entry:</span>
  <span class="k">ret</span> <span class="kt">i64</span> <span class="m">42</span>
<span class="p">}</span>
</code></pre>
<h3 id='types' class='heading'>Types</h3>

<p>LLVM IR is a strong, statically typed language.  As such, values and functions
are tagged with their types, and conversions between them must be explicit (see
<a href="http://llvm.org/docs/LangRef.html#conversion-operations">Conversion Operators</a>).
LLVMSwift represents this with values conforming to the <code>IRType</code> protocol and defines
the following types:</p>

<table><thead>
<tr>
<th style="text-align: center"><strong>Type</strong></th>
<th style="text-align: center"><strong>Represents</strong></th>
</tr>
</thead><tbody>
<tr>
<td style="text-align: center">VoidType</td>
<td style="text-align: center">Nothing; Has no size</td>
</tr>
<tr>
<td style="text-align: center">IntType</td>
<td style="text-align: center">Integer and Boolean values (<code>i1</code>)</td>
</tr>
<tr>
<td style="text-align: center">FloatType</td>
<td style="text-align: center">Floating-point values</td>
</tr>
<tr>
<td style="text-align: center">FunctionType</td>
<td style="text-align: center">Function values</td>
</tr>
<tr>
<td style="text-align: center">LabelType</td>
<td style="text-align: center">Code labels</td>
</tr>
<tr>
<td style="text-align: center">TokenType</td>
<td style="text-align: center">Values paired with instructions</td>
</tr>
<tr>
<td style="text-align: center">MetadataType</td>
<td style="text-align: center">Embedded metadata</td>
</tr>
<tr>
<td style="text-align: center">X86MMXType</td>
<td style="text-align: center">X86 MMX values</td>
</tr>
<tr>
<td style="text-align: center">PointerType</td>
<td style="text-align: center">Pointer values</td>
</tr>
<tr>
<td style="text-align: center">VectorType</td>
<td style="text-align: center">SIMD data</td>
</tr>
<tr>
<td style="text-align: center">ArrayType</td>
<td style="text-align: center">Homogeneous values</td>
</tr>
<tr>
<td style="text-align: center">Structure Type</td>
<td style="text-align: center">Heterogeneous values</td>
</tr>
</tbody></table>
<h3 id='control-flow' class='heading'>Control Flow</h3>

<p>Control flow is changed through the unconditional and conditional <code>br</code> instruction.</p>

<p>LLVM is also famous for a control-flow specific IR construct called a <a href="http://llvm.org/docs/LangRef.html#phi-instruction">PHI node</a>.  Because all instructions in LLVM IR are in SSA (Single Static Assignment) form, a PHI node is necessary when the value of a variable assignment depends on the path the flow of control takes through the program.  For example, let&rsquo;s try to build the following Swift program in IR:</p>
<pre class="highlight swift"><code><span class="kd">func</span> <span class="nf">calculateFibs</span><span class="p">(</span><span class="n">_</span> <span class="nv">backward</span> <span class="p">:</span> <span class="kt">Bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Double</span> <span class="p">{</span>
  <span class="k">let</span> <span class="nv">retVal</span> <span class="p">:</span> <span class="kt">Double</span>
  <span class="k">if</span> <span class="o">!</span><span class="n">backward</span> <span class="p">{</span>
    <span class="c1">// the fibonacci series (sort of)</span>
    <span class="n">retVal</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="mi">89</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="c1">// the fibonacci series (sort of) backwards</span>
    <span class="n">retVal</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="mi">109</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="n">retVal</span>
<span class="p">}</span>
</code></pre>

<p>Notice that the value of <code>retVal</code> depends on the path the flow of control takes through this program, so we must emit a PHI node to properly initialize it:</p>
<pre class="highlight swift"><code><span class="k">let</span> <span class="nv">function</span> <span class="o">=</span> <span class="n">builder</span><span class="o">.</span><span class="nf">addFunction</span><span class="p">(</span>
                 <span class="s">"calculateFibs"</span><span class="p">,</span> 
                 <span class="nv">type</span><span class="p">:</span> <span class="kt">FunctionType</span><span class="p">(</span><span class="nv">argTypes</span><span class="p">:</span> <span class="p">[</span><span class="kt">IntType</span><span class="o">.</span><span class="n">int1</span><span class="p">],</span> 
                 <span class="nv">returnType</span><span class="p">:</span> <span class="kt">FloatType</span><span class="o">.</span><span class="n">double</span><span class="p">)</span>
               <span class="p">)</span>
<span class="k">let</span> <span class="nv">entryBB</span> <span class="o">=</span> <span class="n">function</span><span class="o">.</span><span class="nf">appendBasicBlock</span><span class="p">(</span><span class="nv">named</span><span class="p">:</span> <span class="s">"entry"</span><span class="p">)</span>
<span class="n">builder</span><span class="o">.</span><span class="nf">positionAtEnd</span><span class="p">(</span><span class="nv">of</span><span class="p">:</span> <span class="n">entryBB</span><span class="p">)</span>

<span class="c1">// allocate space for a local value     </span>
<span class="k">let</span> <span class="nv">local</span> <span class="o">=</span> <span class="n">builder</span><span class="o">.</span><span class="nf">buildAlloca</span><span class="p">(</span><span class="nv">type</span><span class="p">:</span> <span class="kt">FloatType</span><span class="o">.</span><span class="n">double</span><span class="p">,</span> <span class="nv">name</span><span class="p">:</span> <span class="s">"local"</span><span class="p">)</span>

<span class="c1">// Compare to the condition</span>
<span class="k">let</span> <span class="nv">test</span> <span class="o">=</span> <span class="n">builder</span><span class="o">.</span><span class="nf">buildICmp</span><span class="p">(</span><span class="n">function</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="kt">IntType</span><span class="o">.</span><span class="n">int1</span><span class="o">.</span><span class="nf">zero</span><span class="p">(),</span> <span class="o">.</span><span class="n">notEqual</span><span class="p">)</span>

<span class="c1">// Create basic blocks for "then", "else", and "merge"</span>
<span class="k">let</span> <span class="nv">thenBB</span> <span class="o">=</span> <span class="n">function</span><span class="o">.</span><span class="nf">appendBasicBlock</span><span class="p">(</span><span class="nv">named</span><span class="p">:</span> <span class="s">"then"</span><span class="p">)</span>
<span class="k">let</span> <span class="nv">elseBB</span> <span class="o">=</span> <span class="n">function</span><span class="o">.</span><span class="nf">appendBasicBlock</span><span class="p">(</span><span class="nv">named</span><span class="p">:</span> <span class="s">"else"</span><span class="p">)</span>
<span class="k">let</span> <span class="nv">mergeBB</span> <span class="o">=</span> <span class="n">function</span><span class="o">.</span><span class="nf">appendBasicBlock</span><span class="p">(</span><span class="nv">named</span><span class="p">:</span> <span class="s">"merge"</span><span class="p">)</span>

<span class="n">builder</span><span class="o">.</span><span class="nf">buildCondBr</span><span class="p">(</span><span class="nv">condition</span><span class="p">:</span> <span class="n">test</span><span class="p">,</span> <span class="nv">then</span><span class="p">:</span> <span class="n">thenBB</span><span class="p">,</span> <span class="nv">else</span><span class="p">:</span> <span class="n">elseBB</span><span class="p">)</span>

<span class="c1">// MARK: Then Block</span>
<span class="n">builder</span><span class="o">.</span><span class="nf">positionAtEnd</span><span class="p">(</span><span class="nv">of</span><span class="p">:</span> <span class="n">thenBB</span><span class="p">)</span>
<span class="c1">// local = 1/89, the fibonacci series (sort of)</span>
<span class="k">let</span> <span class="nv">thenVal</span> <span class="o">=</span> <span class="kt">FloatType</span><span class="o">.</span><span class="n">double</span><span class="o">.</span><span class="nf">constant</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="mi">89</span><span class="p">)</span>
<span class="c1">// Branch to the merge block</span>
<span class="n">builder</span><span class="o">.</span><span class="nf">buildBr</span><span class="p">(</span><span class="n">mergeBB</span><span class="p">)</span>

<span class="c1">// MARK: Else Block</span>
<span class="n">builder</span><span class="o">.</span><span class="nf">positionAtEnd</span><span class="p">(</span><span class="nv">of</span><span class="p">:</span> <span class="n">elseBB</span><span class="p">)</span>
<span class="c1">// local = 1/109, the fibonacci series (sort of) backwards</span>
<span class="k">let</span> <span class="nv">elseVal</span> <span class="o">=</span> <span class="kt">FloatType</span><span class="o">.</span><span class="n">double</span><span class="o">.</span><span class="nf">constant</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="mi">109</span><span class="p">)</span>
<span class="c1">// Branch to the merge block</span>
<span class="n">builder</span><span class="o">.</span><span class="nf">buildBr</span><span class="p">(</span><span class="n">mergeBB</span><span class="p">)</span>

<span class="c1">// MARK: Merge Block</span>
<span class="n">builder</span><span class="o">.</span><span class="nf">positionAtEnd</span><span class="p">(</span><span class="nv">of</span><span class="p">:</span> <span class="n">mergeBB</span><span class="p">)</span>
<span class="k">let</span> <span class="nv">phi</span> <span class="o">=</span> <span class="n">builder</span><span class="o">.</span><span class="nf">buildPhi</span><span class="p">(</span><span class="kt">FloatType</span><span class="o">.</span><span class="n">double</span><span class="p">,</span> <span class="nv">name</span><span class="p">:</span> <span class="s">"phi_example"</span><span class="p">)</span>
<span class="n">phi</span><span class="o">.</span><span class="nf">addIncoming</span><span class="p">([</span>
  <span class="p">(</span><span class="n">thenVal</span><span class="p">,</span> <span class="n">thenBB</span><span class="p">),</span>
  <span class="p">(</span><span class="n">elseVal</span><span class="p">,</span> <span class="n">elseBB</span><span class="p">),</span>
<span class="p">])</span>
<span class="n">builder</span><span class="o">.</span><span class="nf">buildStore</span><span class="p">(</span><span class="n">phi</span><span class="p">,</span> <span class="nv">to</span><span class="p">:</span> <span class="n">local</span><span class="p">)</span>
<span class="k">let</span> <span class="nv">ret</span> <span class="o">=</span> <span class="n">builder</span><span class="o">.</span><span class="nf">buildLoad</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="nv">name</span><span class="p">:</span> <span class="s">"ret"</span><span class="p">)</span>
<span class="n">builder</span><span class="o">.</span><span class="nf">buildRet</span><span class="p">(</span><span class="n">ret</span><span class="p">)</span>
</code></pre>

<p>This program generates the following IR:</p>
<pre class="highlight llvm"><code><span class="k">define</span> <span class="kt">double</span> <span class="vg">@calculateFibs</span><span class="p">(</span><span class="kt">i1</span><span class="p">)</span> <span class="p">{</span>
<span class="nl">entry:</span>
  <span class="nv">%local</span> <span class="p">=</span> <span class="k">alloca</span> <span class="kt">double</span>
  <span class="nv">%1</span> <span class="p">=</span> <span class="k">icmp</span> <span class="k">ne</span> <span class="kt">i1</span> <span class="nv">%0</span><span class="p">,</span> <span class="k">false</span>
  <span class="k">br</span> <span class="kt">i1</span> <span class="nv">%1</span><span class="p">,</span> <span class="kt">label</span> <span class="nv">%then</span><span class="p">,</span> <span class="kt">label</span> <span class="nv">%else</span>

<span class="nl">then:</span>                                             <span class="c1">; preds = %entry</span>
  <span class="k">br</span> <span class="kt">label</span> <span class="nv">%merge</span>

<span class="nl">else:</span>                                             <span class="c1">; preds = %entry</span>
  <span class="k">br</span> <span class="kt">label</span> <span class="nv">%merge</span>

<span class="nl">merge:</span>                                            <span class="c1">; preds = %else, %then</span>
  <span class="nv">%phi_example</span> <span class="p">=</span> <span class="k">phi</span> <span class="kt">double</span> <span class="p">[</span> <span class="m">0x3F8702E05C0B8170</span><span class="p">,</span> <span class="nv">%then</span> <span class="p">],</span> <span class="p">[</span> <span class="m">0x3F82C9FB4D812CA0</span><span class="p">,</span> <span class="nv">%else</span> <span class="p">]</span>
  <span class="k">store</span> <span class="kt">double</span> <span class="nv">%phi_example</span><span class="p">,</span> <span class="kt">double</span><span class="p">*</span> <span class="nv">%local</span>
  <span class="nv">%ret</span> <span class="p">=</span> <span class="k">load</span> <span class="kt">double</span><span class="p">,</span> <span class="kt">double</span><span class="p">*</span> <span class="nv">%local</span>
  <span class="k">ret</span> <span class="kt">double</span> <span class="nv">%ret</span>
<span class="p">}</span>
</code></pre>
<h3 id='jit' class='heading'>JIT</h3>

<p>LLVMSwift provides a JIT abstraction to make executing code in LLVM modules quick and easy.  Let&rsquo;s execute the PHI node example from before:</p>
<pre class="highlight swift"><code><span class="c1">// Setup the JIT</span>
<span class="k">let</span> <span class="nv">jit</span> <span class="o">=</span> <span class="k">try!</span> <span class="kt">JIT</span><span class="p">(</span><span class="nv">module</span><span class="p">:</span> <span class="n">module</span><span class="p">,</span> <span class="nv">machine</span><span class="p">:</span> <span class="kt">TargetMachine</span><span class="p">())</span>
<span class="kd">typealias</span> <span class="kt">FnPtr</span> <span class="o">=</span> <span class="kd">@convention(c)</span> <span class="p">(</span><span class="kt">Bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Double</span>
<span class="c1">// Retrieve a handle to the function we're going to invoke</span>
<span class="k">let</span> <span class="nv">fnAddr</span> <span class="o">=</span> <span class="n">jit</span><span class="o">.</span><span class="nf">addressOfFunction</span><span class="p">(</span><span class="nv">name</span><span class="p">:</span> <span class="s">"calculateFibs"</span><span class="p">)</span>
<span class="k">let</span> <span class="nv">fn</span> <span class="o">=</span> <span class="nf">unsafeBitCast</span><span class="p">(</span><span class="n">fnAddr</span><span class="p">,</span> <span class="nv">to</span><span class="p">:</span> <span class="kt">FnPtr</span><span class="o">.</span><span class="k">self</span><span class="p">)</span>
<span class="c1">// Call the function!</span>
<span class="nf">print</span><span class="p">(</span><span class="nf">fn</span><span class="p">(</span><span class="kc">true</span><span class="p">))</span> <span class="c1">// 0.00917431192660551...</span>
<span class="nf">print</span><span class="p">(</span><span class="nf">fn</span><span class="p">(</span><span class="kc">false</span><span class="p">))</span> <span class="c1">// 0.0112359550561798...</span>
</code></pre>
<h2 id='installation' class='heading'>Installation</h2>

<p>There are a couple, annoying steps you need to get it working before it&rsquo;ll
build.</p>

<ul>
<li>Install LLVM 4.0 using your favorite package manager. For example:

<ul>
<li><code>brew install llvm</code></li>
</ul></li>
<li>Ensure <code>llvm-config</code> is in your <code>PATH</code>

<ul>
<li>That will reside in the <code>/bin</code> folder wherever your package manager
installed LLVM.</li>
</ul></li>
<li>Create a pkg-config file for your specific LLVM installation.

<ul>
<li>We have a utility for this: <code>swift utils/make-pkgconfig.swift</code></li>
</ul></li>
</ul>

<p>Once you do that, you can add LLVMSwift as a dependency for your own Swift
compiler projects!</p>
<h3 id='installation-without-swift-package-manager' class='heading'>Installation without Swift Package Manager</h3>

<p>We really recommend using SwiftPM with LLVMSwift, but if your project is
structured in such a way that makes using SwiftPM impractical or impossible,
you can still use LLVMSwift by passing the <code>-DNO_SWIFTPM</code> to swift when
compiling.</p>

<ul>
<li>Xcode:

<ul>
<li>Add this repository as a git submodule</li>
<li>Add the files in <code>Sources/</code> to your Xcode project.</li>
<li>Under <code>Other Swift Flags</code>, add <code>-DNO_SWIFTPM</code>.</li>
<li>Under <code>Library Search Paths</code> add the output of <code>llvm-config --libdir</code></li>
<li>Under <code>Header Search Paths</code> add the output of <code>llvm-config --includedir</code></li>
<li>Under <code>Link Target with Libraries</code> drag in
<code>/path/to/your/llvm/lib/libLLVM.dylib</code></li>
</ul></li>
</ul>

<p>This project is used by <a href="https://github.com/harlanhaskins/trill">Trill</a> for
all its code generation.</p>
<h2 id='authors' class='heading'>Authors</h2>

<ul>
<li>Harlan Haskins (<a href="https://github.com/harlanhaskins">@harlanhaskins</a>)</li>
<li>Robert Widmann (<a href="https://github.com/CodaFi">@CodaFi</a>)</li>
</ul>
<h2 id='license' class='heading'>License</h2>

<p>This project is released under the MIT license, a copy of which is available
in this repo.</p>

          </section>
        </section>
        <section id="footer">
          <p>&copy; 2017 <a class="link" href="" target="_blank" rel="external"></a>. All rights reserved. (Last updated: 2017-08-07)</p>
          <p>Generated by <a class="link" href="https://github.com/realm/jazzy" target="_blank" rel="external">jazzy ♪♫ v0.8.3</a>, a <a class="link" href="http://realm.io" target="_blank" rel="external">Realm</a> project.</p>
        </section>
      </article>
    </div>
  </body>
</div>
</html>
